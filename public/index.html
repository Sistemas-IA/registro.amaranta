<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Registro</title>

  <!-- HSTS -->
  <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.google.com/recaptcha/ https://www.gstatic.com; script-src-elem 'self' https://www.google.com/recaptcha/ https://www.gstatic.com; frame-src 'self' https://www.google.com/recaptcha/; object-src 'none';">
  <!-- X-Frame-Options -->
  <meta http-equiv="X-Frame-Options" content="DENY">
  <!-- X-Content-Type-Options -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <!-- Referrer-Policy -->
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <!-- reCAPTCHA v3 -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Le2sYMrAAAAABmpey7GOWmQHVua3PxJ5gnHsbGp"></script>
  <style>
    .error-message { color: #c00; margin: 0.5em 0; }
    #error-container { display: none; margin-bottom: 1em; }
    form div.field { margin-bottom: 0.5em; }
    form label { display: block; }
  </style>
</head>
<body>
  <h1>Formulario de Registro</h1>
  <form id="register-form">
    <div id="error-container"></div>

    <div class="field">
      <label>Nombre:<br>
        <input type="text" id="nombre" name="nombre" maxlength="30" />
      </label>
    </div>
    <div class="field">
      <label>Apellido:<br>
        <input type="text" id="apellido" name="apellido" maxlength="30" />
      </label>
    </div>
    <div class="field">
      <label>DNI:<br>
        <input type="text" id="dni" name="dni" maxlength="8" />
      </label>
    </div>
    <div class="field">
      <label>Teléfono:<br>
        <input type="text" id="telefono" name="telefono" maxlength="13" />
      </label>
    </div>
    <div class="field">
      <label>Email:<br>
        <input type="email" id="email" name="email" />
      </label>
    </div>
    <div class="field">
      <label>Dirección:<br>
        <input type="text" id="direccion" name="direccion" maxlength="100" />
      </label>
    </div>
    <div class="field">
      <label>Comentarios:<br>
        <textarea id="comentarios" name="comentarios" rows="4" maxlength="300"></textarea>
      </label>
    </div>

    <!-- Honeypots y campos ocultos -->
    <input type="hidden" id="zona" name="zona" value="" />
    <input type="hidden" id="estado" name="estado" value="Pendiente" />
    <input type="hidden" id="lista" name="lista" value="" />

    <button type="submit">Enviar</button>
  </form>

  <script>
    // Extrae parámetro ?l= de la URL
    const params = new URLSearchParams(window.location.search);
    const listaParam = params.get('l');
    if (listaParam) document.getElementById('lista').value = listaParam;

    // Mensajes de error configurables
    const ERRORS = {
      required:       'Este campo es obligatorio.',
      maxLength:      max => `Máximo ${max} caracteres permitidos.`, 
      invalidPattern: 'El formato no es válido.',
      invalidDNI:     'El DNI debe tener 8 dígitos.',
      invalidPhone:   'El teléfono debe tener entre 9 y 13 dígitos.',
      invalidList:    'La lista debe ser un número entre 1 y 99.',
      honeypot:       'Spam detectado.'
    };

    // Patrones de validación
    const PATTERNS = {
      name:   /^[A-Za-zÁÉÍÓÚáéíóúÑñ ]{1,30}$/, 
      dni:    /^\d{8}$/, 
      phone:  /^\d{9,13}$/, 
      email:  /^[^@\s]+@[^@\s]+\.[^@\s]+$/, 
      lista:  /^[1-9][0-9]?$/"
    };

    function validateForm(data) {
      const errors = {};
      if (!data.nombre) errors.nombre = ERRORS.required;
      else if (!PATTERNS.name.test(data.nombre)) errors.nombre = ERRORS.maxLength(30);
      if (!data.apellido) errors.apellido = ERRORS.required;
      else if (!PATTERNS.name.test(data.apellido)) errors.apellido = ERRORS.maxLength(30);
      if (!data.dni) errors.dni = ERRORS.required;
      else if (!PATTERNS.dni.test(data.dni)) errors.dni = ERRORS.invalidDNI;
      if (!data.telefono) errors.telefono = ERRORS.required;
      else if (!PATTERNS.phone.test(data.telefono)) errors.telefono = ERRORS.invalidPhone;
      if (!data.email) errors.email = ERRORS.required;
      else if (!PATTERNS.email.test(data.email)) errors.email = ERRORS.invalidPattern;
      if (!data.direccion) errors.direccion = ERRORS.required;
      else if (data.direccion.length > 100) errors.direccion = ERRORS.maxLength(100);
      if (data.comentarios && data.comentarios.length > 300) errors.comentarios = ERRORS.maxLength(300);
      if (data.zona) errors.zona = ERRORS.honeypot;
      if (data.estado !== 'Pendiente') errors.estado = ERRORS.honeypot;
      if (data.lista && !PATTERNS.lista.test(data.lista)) errors.lista = ERRORS.invalidList;
      return errors;
    }

    function showErrors(errors) {
      const container = document.getElementById('error-container');
      container.innerHTML = '';
      for (let field in errors) {
        const msg = document.createElement('div');
        msg.className = 'error-message';
        msg.textContent = errors[field];
        container.appendChild(msg);
      }
      container.style.display = 'block';
    }

    const form = document.getElementById('register-form');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const data = {
        nombre: document.getElementById('nombre').value.trim(),
        apellido: document.getElementById('apellido').value.trim(),
        dni: document.getElementById('dni').value.trim(),
        telefono: document.getElementById('telefono').value.trim(),
        email: document.getElementById('email').value.trim(),
        direccion: document.getElementById('direccion').value.trim(),
        comentarios: document.getElementById('comentarios').value.trim(),
        zona: document.getElementById('zona').value,
        estado: document.getElementById('estado').value,
        lista: document.getElementById('lista').value
      };
      const errors = validateForm(data);
      if (Object.keys(errors).length) {
        showErrors(errors);
        return;
      }
      grecaptcha.ready(async () => {
        const token = await grecaptcha.execute(
          '6Le2sYMrAAAAABmpey7GOWmQHVua3PxJ5gnHsbGp',
          { action: 'register' }
        );
        data.recaptchaToken = token;
        // Lógica de fetch a la API...
      });
    });
  </script>
</body>
</html>
