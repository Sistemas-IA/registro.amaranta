<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Registro</title>

  <!-- reCAPTCHA v2 invisible -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    body  { font-family: system-ui, sans-serif; margin:0; padding:1rem; }
    form  { display:block; max-width:420px; margin:0 auto; }
    input, textarea, button {
      display:block; margin-bottom:.35rem; padding:.5rem; font-size:1rem;
    }
    small.error-msg { color:crimson; font-size:.8rem; margin:-.25rem 0 .25rem; display:none; }
    button[disabled] {
      opacity:.6; cursor:not-allowed; pointer-events:none;
    }
  </style>
</head>
<body>
  <form id="registro-form">
    <input name="nombre"          placeholder="Nombre"             required />
    <small class="error-msg"></small>

    <input name="apellido"        placeholder="Apellido"           required />
    <small class="error-msg"></small>

    <input name="dni"             placeholder="DNI (8 dígitos)"    required />
    <small class="error-msg"></small>

    <input id="codArea"           name="codArea"        placeholder="Código de área"   required />
    <small class="error-msg"></small>

    <input id="numeroTelefono"    name="numeroTelefono" placeholder="Número de teléfono" required />
    <small class="error-msg"></small>

    <input name="email"           placeholder="Email"              required />
    <small class="error-msg"></small>

    <input name="direccion"       placeholder="Dirección"          required />
    <small class="error-msg"></small>

    <textarea name="comentarios"  placeholder="Comentarios (opcional)"></textarea>
    <small class="error-msg"></small>

    <!-- Honeypots -->
    <input name="zona"   tabindex="-1" style="display:none" />
    <input name="estado" tabindex="-1" style="display:none" />

    <!-- Campo oculto lista -->
    <input id="lista" name="lista" type="hidden" />

    <button
      class="g-recaptcha"
      data-sitekey="6LdNAXUrAAAAAIz5Vi5nLnkSHF-fjoTXPSKa2x6y"
      data-callback="onSubmit"
      data-size="invisible"
      data-badge="bottomright"
      disabled>
      Enviar
    </button>
  </form>

  <script>
  /* Patrones de validación */
  const patterns = {
    nombre:         /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
    apellido:       /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
    dni:            /^\d{8}$/,
    codArea:        /^\d{2,4}$/,
    numeroTelefono: /^\d{7,9}$/,
    email:          /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/,
    direccion:      /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ.,#\/º°()\-\s]{5,100}$/,
    comentarios:    /^.{0,300}$/          // opcional
  };

  const form      = document.getElementById('registro-form');
  const submitBtn = form.querySelector('button.g-recaptcha');

  /* Rellenar lista desde ?l= */
  document.getElementById('lista').value =
    new URLSearchParams(location.search).get('l') ?? '';

  /* Mostrar / ocultar error */
  function showError(input, msg) {
    const span = input.nextElementSibling;
    span.textContent = msg;
    span.style.display = msg ? 'block' : 'none';
  }

  /* Validar un campo */
  function validateInput(input) {
    const key = input.getAttribute('name') || input.id;
    if (!patterns[key]) return true;

    const val      = input.value.trim();
    const touched  = input.dataset.touched === 'true';
    const required = key !== 'comentarios';               // comentarios opcional
    const passes   = val === '' ? false : patterns[key].test(val);
    const valid    = required ? (val !== '' && passes) : (val === '' || passes);

    showError(input, touched && val !== '' && !passes ? 'Valor inválido' : '');
    return valid;
  }

  /* Eventos */
  form.querySelectorAll('input, textarea').forEach(el => {
    if (el.type === 'hidden') return;

    el.addEventListener('blur', () => {
      el.dataset.touched = 'true';
      validateInput(el);
      toggleSubmit();
    });

    el.addEventListener('input', () => {
      validateInput(el);
      toggleSubmit();
    });
  });

  /* Habilitar / deshabilitar botón */
  function toggleSubmit() {
    const allValid = [...form.querySelectorAll('input, textarea')]
      .filter(el => el.type !== 'hidden')
      .every(validateInput);
    submitBtn.disabled = !allValid;
  }

  /* —— Asegurar estado del botón después de que reCAPTCHA re-renderiza —— */
  window.addEventListener('load', () => {
    submitBtn.disabled = true;
    toggleSubmit();
  });

  /* Submit */
  form.addEventListener('submit', e => {
    e.preventDefault();
    if (submitBtn.disabled) return;
    grecaptcha.execute();
  });

  /* Mensajes centralizados */
  const MSG = {
    duplicado_dni:   'Ese DNI ya existe.',
    duplicado_tel:   'Teléfono ya registrado.',
    duplicado_email: 'E-mail ya registrado.',
    ok:              'Formulario enviado correctamente'
  };

  /* Callback reCAPTCHA */
  function onSubmit(token) {
    const data = new FormData(form);
    data.append('g-recaptcha-response', token);

    fetch('/api/register', { method:'POST', body:data })
      .then(r => r.json())
      .then(d => {
        if (d.error) {                          // Dato duplicado u otro error
          alert(MSG[d.error] || 'Dato duplicado');
          grecaptcha.reset();                   // ← permite volver a enviar
          return;
        }

        alert(d.message || MSG.ok);             // Éxito real
        form.reset();
        submitBtn.disabled = true;
      })
      .catch(() => alert('Error al enviar, intentá de nuevo más tarde'));
  }
  </script>
</body>
</html>
