<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Registro</title>

  <!-- reCAPTCHA v3 (background scoring) -->
  <script src="https://www.google.com/recaptcha/api.js?render=6Le2sYMrAAAAABmpey7GOWmQHVua3PxJ5gnHsbGp"></script>
  <!-- reCAPTCHA v2 Invisible -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    body  { font-family: system-ui, sans-serif; margin:0; padding:1rem; }
    form  { display:block; max-width:420px; margin:0 auto; }
    input, textarea, button { display:block; margin-bottom:.35rem; padding:.5rem; font-size:1rem; }
    small.error-msg { color:crimson; font-size:.8rem; margin:-.25rem 0 .25rem; display:none; }
    button[disabled] { opacity:.6; cursor:not-allowed; pointer-events:none; }
  </style>
</head>
<body>
  <form id="registro-form">
    <input name="nombre" placeholder="Nombre" required /><small class="error-msg"></small>
    <input name="apellido" placeholder="Apellido" required /><small class="error-msg"></small>
    <input name="dni" placeholder="DNI (8 dígitos)" required /><small class="error-msg"></small>
    <input id="codArea" name="codArea" placeholder="Código de área" required /><small class="error-msg"></small>
    <input id="numeroTelefono" name="numeroTelefono" placeholder="Número de teléfono" required /><small class="error-msg"></small>
    <input name="email" placeholder="Email" required /><small class="error-msg"></small>
    <input name="direccion" placeholder="Dirección" required /><small class="error-msg"></small>
    <textarea name="comentarios" placeholder="Comentarios (opcional)"></textarea><small class="error-msg"></small>
    <input name="zona"   tabindex="-1" style="display:none" />
    <input name="estado" tabindex="-1" style="display:none" />
    <input id="lista" name="lista" type="hidden" />
    <button id="submitBtn" type="button" disabled>Enviar</button>
  </form>

  <script>
  /* Patrones y validación */
  const patterns = {
    nombre: /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
    apellido: /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
    dni: /^\d{8}$/,
    codArea: /^\d{2,4}$/,
    numeroTelefono: /^\d{7,9}$/,
    email: /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/,
    direccion: /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ.,#\/º°()\-\s]{5,100}$/,
    comentarios: /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ., ()\/#º°\n\r\-]{0,300}$/
  };  
  const MSG = {
    duplicado_dni: 'Ese DNI ya existe.',
    duplicado_tel: 'Teléfono ya registrado.',
    duplicado_email: 'E-mail ya registrado.',
    rate_limit: 'Demasiados intentos, por favor esperá un rato.',
    ok: 'Formulario enviado correctamente',
    recaptcha: 'Error en verificación humana'
  };

  const form = document.getElementById('registro-form');
  const submitBtn = document.getElementById('submitBtn');
  document.getElementById('lista').value = new URLSearchParams(location.search).get('l') || '';

  function showError(input, msg) {
    const span = input.nextElementSibling; span.textContent = msg; span.style.display = msg ? 'block' : 'none';
  }
  function validateInput(input) {
    const key = input.name, val = input.value.trim();
    if (!patterns[key]) return true;
    const passes = val !== '' && patterns[key].test(val);
    const valid = key !== 'comentarios' ? (val !== '' && passes) : true;
    showError(input, val !== '' && !passes ? 'Valor inválido' : '');
    return valid;
  }
  form.querySelectorAll('input, textarea').forEach(el => {
    if (el.type === 'hidden') return;
    el.addEventListener('input', () => { validateInput(el); toggleSubmit(); });
    el.addEventListener('blur', () => { validateInput(el); toggleSubmit(); });
  });
  function toggleSubmit() {
    const allValid = [...form.querySelectorAll('input, textarea')]
      .filter(el => el.type !== 'hidden')
      .every(validateInput);
    submitBtn.disabled = !allValid;
  }
  window.addEventListener('load', toggleSubmit);

  // Variables para tokens y widget
  let v3Token = '';
  let v2WidgetId;

  // Render invisible v2 widget
  grecaptcha.ready(() => {
    v2WidgetId = grecaptcha.render(submitBtn, {
      'sitekey': '6LdNAXUrAAAAAIz5Vi5nLnkSHF-fjoTXPSKa2x6y',
      'size': 'invisible',
      'badge': 'bottomright',
      'callback': onSubmit
    });
  });

  // Paso 1: disparar v3 y enviar a backend
  submitBtn.addEventListener('click', () => {
    if (submitBtn.disabled) return;
    grecaptcha.ready(() => {
      grecaptcha.execute('6Le2sYMrAAAAABmpey7GOWmQHVua3PxJ5gnHsbGp', { action: 'submit' })
        .then(token => {
          v3Token = token;
          const data = new FormData(form);
          data.append('tokenV3', v3Token);
          fetch('/api/register', { method:'POST', body:data })
            .then(r => r.json())
            .then(json => {
              if (json.needV2) grecaptcha.execute(v2WidgetId);
              else if (json.error) { alert(MSG[json.error]||json.error); grecaptcha.reset(v2WidgetId); }
              else { alert(MSG.ok); form.reset(); toggleSubmit(); grecaptcha.reset(v2WidgetId); }
            })
            .catch(() => { alert('Error al enviar, intentá luego'); grecaptcha.reset(v2WidgetId); });
        });
    });
  });

  // Callback v2 Invisible
  function onSubmit(tokenV2) {
    const data = new FormData(form);
    data.append('tokenV3', v3Token);
    data.append('g-recaptcha-response', tokenV2);
    fetch('/api/register', { method:'POST', body:data })
      .then(r => r.json())
      .then(json => {
        if (json.error) alert(MSG[json.error]||json.error);
        else { alert(MSG.ok); form.reset(); }
        toggleSubmit();
        grecaptcha.reset(v2WidgetId);
      })
      .catch(() => { alert('Error al enviar, intentá luego'); grecaptcha.reset(v2WidgetId); });
  }
  </script>
</body>
</html>
