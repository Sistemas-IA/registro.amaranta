<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>
   Formulario de Registro
  </title>
<script async="" defer="" src="https://www.google.com/recaptcha/api.js">
</script>
</head>
<body>
<form id="registro-form">
<input name="nombre" placeholder="Nombre" required="" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<input name="apellido" placeholder="Apellido" required="" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<input name="dni" placeholder="DNI" required="" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<input data-name="codArea" id="codArea" name="codArea" placeholder="Código de área" required="True" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<input data-name="numeroTelefono" id="numeroTelefono" name="numeroTelefono" placeholder="Número de teléfono" required="True" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<input name="email" placeholder="Email" required="" type="email"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<input name="direccion" placeholder="Dirección" required="" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<textarea name="comentarios" placeholder="Comentarios"></textarea>
<small class="error-msg" style="color:red;display:none;">
</small>
<!-- Honeypot -->
<input name="zona" style="display:none" tabindex="-1" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<input name="estado" style="display:none" tabindex="-1" type="text"/>
<small class="error-msg" style="color:red;display:none;">
</small>
<button class="g-recaptcha" data-badge="bottomright" data-callback="onSubmit" data-sitekey="6LdNAXUrAAAAAIz5Vi5nLnkSHF-fjoTXPSKa2x6y" data-size="invisible">
    Enviar
   </button>
<input id="telefono" name="telefono" type="hidden"/>
<input id="lista" name="lista" type="hidden"/>
</form>
<script>
   // Regex patterns
const patterns = {
  nombre: /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\-\s]{2,30}$/,
  apellido: /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\-\s]{2,30}$/,
  dni: /^\d{8}$/,
  codArea: /^\d{2,4}$/,
  numeroTelefono: /^\d{7,9}$/,
  email: /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/,
  direccion: /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ\.\,\-\s]{5,100}$/,
  comentarios: /^.{0,300}$/
};

const form = document.getElementById('registro-form');
const submitBtn = form.querySelector('button.g-recaptcha');

// Llenar lista desde URL
document.getElementById('lista').value =
  new URLSearchParams(location.search).get('l') ?? '';

function showError(input, msg) {
  const errorSpan = input.nextElementSibling;
  errorSpan.textContent = msg;
  errorSpan.style.display = msg ? 'block' : 'none';
}

function validateInput(input) {
  const id = input.getAttribute('name') || input.id;
  if (!patterns[id]) return true; // No pattern, assume valid
  const value = input.value.trim();
  const valid = patterns[id].test(value);
  showError(input, valid ? '' : 'Valor inválido');
  return valid;
}

// Validate on input
form.querySelectorAll('input, textarea').forEach(el => {
  if (el.type === 'hidden') return;
  el.addEventListener('input', () => {
    validateInput(el);
    toggleSubmit();
  });
});

function toggleSubmit() {
  const allValid = [...form.querySelectorAll('input, textarea')].every(el => {
    if (el.type === 'hidden') return true;
    return validateInput(el);
  });
  submitBtn.disabled = !allValid;
}
toggleSubmit();

// Intercept submit
form.addEventListener('submit', function(e) {
  e.preventDefault();
  // final validation
  if (submitBtn.disabled) return;

  // build telefono
  const cod = document.getElementById('codArea').value.trim();
  const num = document.getElementById('numeroTelefono').value.trim();
  const tel = '549' + cod + num;
  document.getElementById('telefono').value = tel;

  grecaptcha.execute();
});

function onSubmit(token){
  const formData = new FormData(form);
  formData.append('g-recaptcha-response', token);

  fetch('/api/register', {
      method: 'POST',
      body: formData
  })
  .then(res => res.json())
  .then(data => {
    alert(data.message || 'Formulario enviado correctamente');
    form.reset();
    toggleSubmit();
  })
  .catch(() => alert('Error al enviar, intentá de nuevo más tarde'));
}
  </script>
</body>
</html>
