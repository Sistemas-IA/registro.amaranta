<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Registro</title>
  <!-- reCAPTCHA v2 invisible -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body { font-family: system-ui, sans-serif; margin:0; padding:1rem; }
    form { display:block; max-width:420px; margin:0 auto; }
    input, textarea, button { display:block; margin-bottom:.35rem; padding:.5rem; font-size:1rem; }
    small.error-msg { color:crimson; font-size:.8rem; margin:-.25rem 0 .25rem; display:none; }
    button[disabled] { opacity:.6; cursor:not-allowed; pointer-events:none; }
  </style>
</head>
<body>
  <form id="registro-form" novalidate>
    <input name="nombre" placeholder="Nombre" required /><small class="error-msg"></small>
    <input name="apellido" placeholder="Apellido" required /><small class="error-msg"></small>
    <input name="dni" placeholder="DNI (8 dígitos)" required /><small class="error-msg"></small>
    <input id="codArea" name="codArea" placeholder="Código de área" required /><small class="error-msg"></small>
    <input id="numeroTelefono" name="numeroTelefono" placeholder="Número de teléfono" required /><small class="error-msg"></small>
    <input name="email" placeholder="Email" required /><small class="error-msg"></small>
    <input name="direccion" placeholder="Dirección" required /><small class="error-msg"></small>
    <textarea name="comentarios" placeholder="Comentarios (opcional)"></textarea><small class="error-msg"></small>
    <!-- Honeypots -->
    <input name="zona" tabindex="-1" style="display:none" />
    <input name="estado" tabindex="-1" style="display:none" />
    <!-- Campo oculto lista -->
    <input id="lista" name="lista" type="hidden" />
    <button
      class="g-recaptcha"
      data-sitekey="6LdNAXUrAAAAAIz5Vi5nLnkSHF-fjoTXPSKa2x6y"
      data-callback="onSubmit"
      data-size="invisible"
      data-badge="bottomright"
      disabled>
      Enviar
    </button>
  </form>

  <script>
    // Patrones de validación
    const patterns = {
      nombre:         /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
      apellido:       /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
      dni:            /^\d{8}$/,
      codArea:        /^\d{2,4}$/,
      numeroTelefono: /^\d{7,9}$/,
      email:          /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/,
      direccion:      /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ.,#\/º°()\-\s]{5,100}$/,
      comentarios:    /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ., ()\/#º°\n\r-]{0,300}$/
    };
    const form = document.getElementById('registro-form');
    const submitBtn = form.querySelector('button.g-recaptcha');
    const touched = new Set();

    // Rellena lista desde ?l=
    document.getElementById('lista').value =
      new URLSearchParams(location.search).get('l') || '';

    function showError(input, msg) {
      const span = input.nextElementSibling;
      span.textContent = msg;
      span.style.display = msg ? 'block' : 'none';
    }

    function validateInput(input, onSubmitCheck = false) {
      const key = input.name || input.id;
      const val = input.value.trim();
      const required = key !== 'comentarios';
      const pattern = patterns[key];

      // Si está vacío:
      if (val === '') {
        if (onSubmitCheck && required) {
          showError(input, 'Requerido');
          return false;
        }
        // no mostrar error en blur/input, sólo en submit
        showError(input, '');
        return !required;
      }

      // Si hay patrón, probarlo
      if (pattern && !pattern.test(val)) {
        showError(input, 'Valor inválido');
        return false;
      }

      showError(input, '');
      return true;
    }

    function toggleSubmit() {
      // Sólo habilitar si TODOS los required están completos y válidos
      const valid = [...form.querySelectorAll('input, textarea')]
        .filter(el => el.type !== 'hidden')
        .every(el => validateInput(el, false));
      submitBtn.disabled = !valid;
    }

    // Blur/Input: marcar touched y validar suavemente
    form.querySelectorAll('input, textarea').forEach(el => {
      if (el.type === 'hidden') return;
      el.addEventListener('blur', () => {
        touched.add(el);
        validateInput(el, false);
        toggleSubmit();
      });
      el.addEventListener('input', () => {
        if (touched.has(el)) validateInput(el, false);
        toggleSubmit();
      });
    });

    window.addEventListener('load', () => { toggleSubmit(); });

    form.addEventListener('submit', e => {
      e.preventDefault();
      // En el submit, validamos todos con onSubmitCheck=true
      let allGood = true;
      form.querySelectorAll('input, textarea').forEach(el => {
        if (el.type === 'hidden') return;
        const ok = validateInput(el, true);
        if (!ok) allGood = false;
      });
      if (!allGood) return;
      grecaptcha.execute();
    });

    // Mensajes de error y éxito
    const MSG = {
      duplicado_dni:   'Ese DNI ya existe.',
      duplicado_tel:   'Ese teléfono ya está registrado.',
      duplicado_email: 'E-mail ya registrado.',
      lista_invalida:  'Lista inválida (1–99).',
      campos_bot:      'Envío inválido.',
      recaptcha:       'Fallo en reCAPTCHA.',
      rate_limit:      'Demasiados intentos, esperá un rato.',
      generic:         'Error inesperado, intentá de nuevo más tarde.',
      ok:              'Formulario enviado correctamente'
    };

    async function onSubmit(token) {
      const data = {};
      new FormData(form).forEach((v, k) => data[k] = v.trim());
      data['g-recaptcha-response'] = token;

      const resp = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const d = await resp.json();

      if (d.error) {
        alert(`Error: ${d.error}\n${MSG[d.error] || 'Error desconocido'}`);
        grecaptcha.reset();
        return;
      }

      alert(MSG.ok);
      form.reset();
      grecaptcha.reset();
      touched.clear();
      toggleSubmit();
    }
  </script>
</body>
</html>
