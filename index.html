<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Registro</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <form id="registro-form">
    <input name="nombre" placeholder="Nombre" required type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <input name="apellido" placeholder="Apellido" required type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <input name="dni" placeholder="DNI" required type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <input id="codArea"  name="codArea"  placeholder="Código de área"   required type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <input id="numeroTelefono" name="numeroTelefono" placeholder="Número de teléfono" required type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <input name="email" placeholder="Email" required type="email" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <input name="direccion" placeholder="Dirección" required type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <textarea name="comentarios" placeholder="Comentarios"></textarea>
    <small class="error-msg" style="color:red;display:none;"></small>

    <!-- Honeypot -->
    <input name="zona"   style="display:none" tabindex="-1" type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <input name="estado" style="display:none" tabindex="-1" type="text" />
    <small class="error-msg" style="color:red;display:none;"></small>

    <button
      class="g-recaptcha"
      data-sitekey="6LdNAXUrAAAAAIz5Vi5nLnkSHF-fjoTXPSKa2x6y"
      data-callback="onSubmit"
      data-size="invisible"
      data-badge="bottomright">
      Enviar
    </button>

    <!-- Campos ocultos que completa el script -->
    <input id="telefono" name="telefono" type="hidden" />
    <input id="lista"    name="lista"    type="hidden" />
  </form>

  <script>
  /* ───────────── Regex de validación ───────────── */
  const patterns = {
    nombre:           /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\-\\s]{2,30}$/,
    apellido:         /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\-\\s]{2,30}$/,
    dni:              /^\\d{8}$/,
    codArea:          /^\\d{2,4}$/,
    numeroTelefono:   /^\\d{7,9}$/,
    email:            /^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$/,
    direccion:        /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ\\.\\,\\-\\s]{5,100}$/,
    comentarios:      /^.{0,300}$/
  };

  const form      = document.getElementById('registro-form');
  const submitBtn = form.querySelector('button.g-recaptcha');

  /* ─ Llenar campo oculto "lista" con ?l= de la URL ─ */
  document.getElementById('lista').value =
    new URLSearchParams(location.search).get('l') ?? '';

  /* ─ Mostrar / ocultar mensaje de error ─ */
  function showError(input, msg) {
    const span = input.nextElementSibling;
    span.textContent   = msg;
    span.style.display = msg ? 'block' : 'none';
  }

  /* ─ Validar un input ─ */
  function validateInput(input) {
    const key = input.getAttribute('name') || input.id;
    if (!patterns[key]) return true;                     // sin patrón = válido

    const val     = input.value.trim();
    const touched = input.dataset.touched === 'true';   // ¿usuario interactuó?
    const valid   = val !== '' && patterns[key].test(val);

    showError(input, touched && !valid ? 'Valor inválido' : '');
    return valid;
  }

  /* ─ Marcar “touched” al salir del campo y validar en vivo ─ */
  form.querySelectorAll('input, textarea').forEach(el => {
    if (el.type === 'hidden') return;

    el.addEventListener('blur', () => {
      el.dataset.touched = 'true';
      validateInput(el);
      toggleSubmit();
    });

    el.addEventListener('input', () => {
      validateInput(el);
      toggleSubmit();
    });
  });

  /* ─ Habilitar / deshabilitar el botón Enviar ─ */
  function toggleSubmit() {
    const allValid = [...form.querySelectorAll('input, textarea')]
      .filter(el => el.type !== 'hidden')
      .every(el => validateInput(el));
    submitBtn.disabled = !allValid;
  }

  /* ─ Interceptar submit: construir teléfono y ejecutar reCAPTCHA ─ */
  form.addEventListener('submit', e => {
    e.preventDefault();
    if (submitBtn.disabled) return;          // seguridad extra

    const cod = document.getElementById('codArea').value.trim();
    const num = document.getElementById('numeroTelefono').value.trim();
    document.getElementById('telefono').value = '549' + cod + num;

    grecaptcha.execute();                    // dispara onSubmit
  });

  /* ─ Callback de reCAPTCHA: enviar el formulario ─ */
  function onSubmit(token) {
    const formData = new FormData(form);
    formData.append('g-recaptcha-response', token);

    fetch('/api/register', { method: 'POST', body: formData })
      .then(r => r.json())
      .then(d => {
        alert(d.message || 'Formulario enviado correctamente');
        form.reset();
        submitBtn.disabled = true;           // vuelve a deshabilitar
      })
      .catch(() => alert('Error al enviar, intentá de nuevo más tarde'));
  }
  </script>
</body>
</html>
