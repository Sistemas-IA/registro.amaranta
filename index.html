<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Registro</title>

  <!-- reCAPTCHA v3 (background scoring) -->
  <script src="https://www.google.com/recaptcha/api.js?render=TU_SITE_KEY_V3"></script>
  <!-- reCAPTCHA v2 Invisible (solo si baja del umbral) -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    body  { font-family: system-ui, sans-serif; margin:0; padding:1rem; }
    form  { display:block; max-width:420px; margin:0 auto; }
    input, textarea, button { display:block; margin-bottom:.35rem; padding:.5rem; font-size:1rem; }
    small.error-msg { color:crimson; font-size:.8rem; margin:-.25rem 0 .25rem; display:none; }
    button[disabled] { opacity:.6; cursor:not-allowed; pointer-events:none; }
  </style>
</head>
<body>
  <form id="registro-form">
    <input name="nombre"          placeholder="Nombre"             required />
    <small class="error-msg"></small>

    <input name="apellido"        placeholder="Apellido"           required />
    <small class="error-msg"></small>

    <input name="dni"             placeholder="DNI (8 dígitos)"    required />
    <small class="error-msg"></small>

    <input id="codArea"           name="codArea"        placeholder="Código de área"   required />
    <small class="error-msg"></small>

    <input id="numeroTelefono"    name="numeroTelefono" placeholder="Número de teléfono" required />
    <small class="error-msg"></small>

    <input name="email"           placeholder="Email"              required />
    <small class="error-msg"></small>

    <input name="direccion"       placeholder="Dirección"          required />
    <small class="error-msg"></small>

    <textarea name="comentarios"  placeholder="Comentarios (opcional)"></textarea>
    <small class="error-msg"></small>

    <!-- Honeypots -->
    <input name="zona"   tabindex="-1" style="display:none" />
    <input name="estado" tabindex="-1" style="display:none" />

    <!-- Campo oculto lista -->
    <input id="lista" name="lista" type="hidden" />

    <!-- Botón sin data-sitekey de v3: lo manejamos por JS -->
    <button id="submitBtn" 
            class="g-recaptcha"
            data-sitekey="TU_SITE_KEY_V2"
            data-callback="onSubmit"
            data-size="invisible"
            data-badge="bottomright"
            disabled>
      Enviar
    </button>
  </form>

  <script>
  /* Patrones y validación (idéntico a tu versión) */
  const patterns = {
    nombre:         /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
    apellido:       /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s-]{2,30}$/,
    dni:            /^\d{8}$/,
    codArea:        /^\d{2,4}$/,
    numeroTelefono: /^\d{7,9}$/,
    email:          /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/,
    direccion:      /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ.,#\/º°()\-\s]{5,100}$/,
    comentarios:    /^[A-Za-z0-9ÁÉÍÓÚÜÑáéíóúüñ., ()\/#º°\n\r-]{0,300}$/
  };

  const MSG = {
    duplicado_dni:   'Ese DNI ya existe.',
    duplicado_tel:   'Teléfono ya registrado.',
    duplicado_email: 'E-mail ya registrado.',
    rate_limit:      'Demasiados intentos, por favor esperá un rato.',
    ok:              'Formulario enviado correctamente',
    recaptcha:       'Error en verificación humana'
  };

  const form      = document.getElementById('registro-form');
  const submitBtn = document.getElementById('submitBtn');

  /* Rellenar lista desde ?l= */
  document.getElementById('lista').value =
    new URLSearchParams(location.search).get('l') ?? '';

  /* Validación inline (idéntica) */
  function showError(input, msg) {
    const span = input.nextElementSibling;
    span.textContent = msg;
    span.style.display = msg ? 'block' : 'none';
  }
  function validateInput(input) {
    const key = input.name || input.id;
    if (!patterns[key]) return true;
    const val      = input.value.trim();
    const touched  = input.dataset.touched === 'true';
    const required = key !== 'comentarios';
    const passes   = val === '' ? false : patterns[key].test(val);
    const valid    = required ? (val !== '' && passes) : (val === '' || passes);
    showError(input, touched && val !== '' && !passes ? 'Valor inválido' : '');
    return valid;
  }
  form.querySelectorAll('input, textarea').forEach(el => {
    if (el.type === 'hidden') return;
    el.addEventListener('blur', () => { el.dataset.touched = 'true'; validateInput(el); toggleSubmit(); });
    el.addEventListener('input', () => { validateInput(el); toggleSubmit(); });
  });
  function toggleSubmit() {
    const allValid = [...form.querySelectorAll('input, textarea')]
      .filter(el => el.type !== 'hidden')
      .every(validateInput);
    submitBtn.disabled = !allValid;
  }
  window.addEventListener('load', () => { submitBtn.disabled = true; toggleSubmit(); });

  /* —— Nuevo flujo: v3 → v2 —— */
  form.addEventListener('submit', async e => {
    e.preventDefault();
    if (submitBtn.disabled) return;

    // 1) Pedimos token v3
    const tokenV3 = await grecaptcha.execute('TU_SITE_KEY_V3', { action: 'submit' });

    // 2) Enviamos TODOS los campos + tokenV3 al server
    const data = new FormData(form);
    data.append('tokenV3', tokenV3);

    const res  = await fetch('/api/register', { method:'POST', body:data });
    const json = await res.json();

    if (json.needV2) {
      // 3) Si el server pide v2, disparamos reto invisible
      grecaptcha.execute();
    } else if (json.error) {
      // 4) Error (rate, duplicados, o recaptcha)
      alert(MSG[json.error] || json.error);
      grecaptcha.reset();
    } else {
      // 5) Éxito
      alert(MSG.ok);
      form.reset();
      grecaptcha.reset();
      submitBtn.disabled = true;
    }
  });

  /* Callback reCAPTCHA v2 Invisible */
  function onSubmit(tokenV2) {
    const data = new FormData(form);
    // solo tokenV2: el v3 ya pasó en el primer paso
    data.append('g-recaptcha-response', tokenV2);

    fetch('/api/register', { method:'POST', body:data })
      .then(r => r.json())
      .then(d => {
        if (d.error) {
          alert(MSG[d.error] || d.error);
        } else {
          alert(MSG.ok);
          form.reset();
        }
        grecaptcha.reset();
        submitBtn.disabled = true;
      })
      .catch(() => {
        alert('Error al enviar, intentá luego');
        grecaptcha.reset();
      });
  }
  </script>
</body>
</html>
